# Day 2 - Lab 2

DevIntersection Security Workshop

## Exercise 1 : Azure Sentinel Basics

1. Open the Azure Portal
2. Select **Azure Sentinel**

    ![Azure Sentinel is highlighted.](media/sentinel-browse.png "Browse to Azure Sentinel")

3. Select **+Add**

    ![Add button is highlighted.](media/sentinel-add-workspace.png "Select Add")

4. Select the **wssecuritySUFFIX** log analytics workspace, then select **Add Azure Sentinel**

5. Select **Logs**, notice your previous log analytics queries are displayed and available to run

6. Explore the various Azure Sentinel blade items

    ![Azure Sentinel is displayed.](media/sentinel-view.png "Browse the Sentinel blade")

## Exercise 2 : Azure Sentinel Data Sources

1. In the Azure Sentinel blade, under **Configuration**, select **Data connectors**
2. Select **Azure Active Directory**

    ![The click path is displayed.](media/sentinel-data-connector-aad.png "Select Azure Active Directory connector")

3. In the side dialog, notice the Data Types that will be imported (`SigninLogs` and `AuditLogs`)
4. Select **Open connector page**

    ![The click path is displayed.](media/sentinel-data-connector-aad-details.png "Select Azure Active Directory connector")

    > **NOTE** You would need to have `global administrator` or `security administrator` access to the Azure AD tenant in order to make the connection. Unfortunately in these labs, your lab user does not have this level of access.

    ![The connector page is displayed.](media/sentinel-data-connector-aad-connect.png "Review the connector page screenshot")

## Exercise 3 : Azure Sentinel Workbooks

1. In the Azure Sentinel blade, under **Threat Management**, select **Workbooks**
2. Select **Azure Security Center for IoT Alerts**

   ![IoT Workbook is displayed.](media/sentinel-workbook-iot.png "Select the IoT Workbook")

3. Select **Save**
4. For the workbook location, select **East US**
5. Select **OK**
6. Select **View saved workbook**

    ![IoT Workbook is displayed.](media/sentinel-workbook-iot-dashboard.png "Select the IoT Workbook")

    > **NOTE** You would need to have setup the IoT labs in order to see events in this workbook.

7. Browse back to the Sentinel Workbooks blade
8. Select **Microsoft Web Application (WAF)- firewall events**
9. Select **Save**

    ![WAF Firewall events Workbook is displayed.](media/sentinel-workbook-fw.png "Select the IoT Workbook")

10. For the workbook location, select **East US**
11. Select **OK**
12. Select **View saved workbook**

    > **NOTE** You would need to have completed the Web Application Gateway/Application Firewall lab in order to see events in this workbook.

## Exercise 2 : Azure Sentinel Hunting

1. In the Azure Sentinel blade, select **Hunting**
2. Review the page, notice it has several pre-built queries for `hunting` log data for events that are of interest

    ![Hunting is displayed.](media/sentinel-hunting.png "Review the Hunting blade")

3. Select one of the items, it will display the details of what that item does:

    ![Hunting example is displayed.](media/sentinel-hunting-example.png "Review a Hunting example")

## Exercise 3 : Azure Sentinel Incidents and Investigation

### Task 1: Setup Query Rule

1. In the Azure Sentinel blade, under **Configuration**, select **Analytics**
2. Select **+Create**, then select **Schedule query rule**

   ![The click path is displayed.](media/sentinel-analytics.png "Select to create a new scheduled query rule")

3. For the name, type **Custom threats**
4. For the tactics, select **Discovery**
5. For the severity, select **High**
6. Select **Next: Set rule logic**

    ![Query rules details are displayed.](media/sentinel-query-rule.png "Enter the query rules details")

7. For the rule query, type the following:

    ```output
    OrgSecurity_CL
    | where IsThreat_b == true
    | extend IPCustomEntity = IPAddress
    | extend HostCustomEntity = Computer
    ```

8. Select **Next: Incident Settings**
9. Ensure the **Create incidents from alerts trigger by this analytics rule** is toggled to **Enabled**
10. Ensure the **Group related alerts, trigger by this analytics rule, into incidents** is toggled to **Enabled**
11. Ensure the **Group related alerts, triggered by this analytics rule in incidents**
12. For the time frame, select **5 Hours**
13. For the grouping, select **Grouping alerts into a single incident if the selected entities match**
14. Select the **IP** entity
15. Select **Next: Automated response**
16. Select **Next: Review**
17. Select **Create**

### Task 2: Investigate Incident

1. In the **Azure Sentinel** blade, select **Incidents**.
2. TODO

## Exercise 4 : Azure Sentinel Notebooks

### Task 1: Import Notebook

1. In the **Azure Sentinel** blade, select **Notebooks**.
2. Review the list of sample notebooks
3. Select the **Go to your Notebooks** link, you will be redirected to the [Azure Notebooks](https://notebooks.azure.com) site.

    ![The click path is displayed.](./media/sentinel-notebooks.png "Select Go to your notebook link")

4. If not already logged in, enter your lab Azure credentials.
5. Upload the `c:\LabFiles\artifacts\Azure Sentinel ML.ipynb` file
6. In another browser tab, navigate to the [Azure Active Directory page](https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/Overview), copy your `Tenant ID` for use later.

    ![The Azure AD page is displayed.](./media/sentinel-azuread-tenant-id.png "Copy the tenant id")

7. Browse to your **wssecuritySUFFIX** log analytics workspace, copy the workspace id.

### Task 2: Create VirusTotal account

1. Open [VirusTotal web site](https://www.virustotal.com/gui/join-us)
2. Fill in the form details, select **Join us**
3. Log in to the website, in the top right navigation, select your user icon
4. Select **API Key**

    ![The click path is displayed.](./media/virustotal-browse.png "Select API Key")

5. Copy the API Key for later steps

    ![The API Key is highlighted.](./media/virustotal-apikey.png "Select the API key")

### Task 3: Create MaxMind account

1. Open the MaxMind [sign up page](https://www.maxmind.com/en/geolite2/signup)
2. Fill out the sign up form, select **Continue**
3. Login to the MaxMind site
4. Select **My License Key**, then select **Generate new license key**

    ![The click path is highlighted.](./media/maxmind-api-key.png "Create a new API key")

### Task 4: Execute a Hunt

1. Switch back to the NoteBook
2. Select **Run**, follow each of the cells as they are executed.  

    ![The Run button is highlighted.](./media/sentinel-notebook-run.png "Run the notebook")

3. Some cells will output information:

    ![A cell with output.](./media/sentinel-notebook-cell-output.png "Review the output")

4. Some will prompt you for data such as the Workspace, TenantId and API keys:

    ![A cell with input.](./media/sentinel-notebook-cell-input.png "Enter your information in the cell")

5. Another cell will ask you to generate an access token

    ![A cell to connect to Azure.](./media/sentinel-notebook-cell-azure-login.png "Copy the device token to azure for authentication")

6. Copy the device code and click the **Copy code to dashboard and authenticate**

7. In the dialog that opens, copy the device code

8. Login using the lab username and password

9. Continue to run a few more cells, you should see a cell output the Log Analytics table and the `SigninLogs` schema:

    ![Cell output is displayed.](./media/sentinel-notebook-cell-log-analytics-tables.png "Review the output")

10. One cell will display the queries available to you

    ![Cell output is displayed.](./media/sentinel-notebook-cell-log-analytics-queries.png "Review the output")

11. The next cell will display kusto query details

    ![Cell output is displayed.](./media/sentinel-notebook-cell-log-analytics-query-details.png "Review the output")

12. The next cell will execute a query passing in parameters:

    ![Cell output is displayed.](./media/sentinel-notebook-cell-log-analytics-query-execution.png "Review the output")

13. Run the remaining cells, you will make calls to the external API providers to enrich the log data with threat levels and IP Address analysis

## Exercise 5 : Extending Azure Sentinel Incidents (Optional)

This task requires registration to gain access to an API Key. It can take a few days to do this action.

### Task 1 : RiskIQ Api Key

1. Open a browser window to https://api.riskiq.net
2. In the left navigation, select the **Register Now** link
3. Fill out the form, login using the email you used in the form
4. Register and validate your email in the email
5. Login to the site, select the profile icon, then select **Developers->API**

    ![The click path is displayed.](./media/maxmind-profile.png "Browse to the API key")

6. Select **Show** for the User, record your API Key and Secret

### Task 2 : Extend Azure Sentinel

1. Open a browser window to https://github.com/Azure/Azure-Sentinel/tree/master/Playbooks/Enrich-SentinelIncident-RiskIQ-IP-Passive-DNS
2. Click the **Deploy to Azure** button
3. Be sure you are logged into your lab account
4. Select your subscription and resource group
5. For the playbook name, ensure **Recent-IP-Passive-DNS** is displayed
6. For your username, type the lab username

    ![The custom deployment parameters are displayed.](./media/riskiq-azure-deployment.png "Enter the template parameters")

7. Select the **I agree..** checkbox
8. Select **Purchase**
9. In the Azure portal, navigate to your Azure Sentinel and your log analytics workspace
10. Select **Playbooks** from the Azure Sentinel navigation menu
11. Select the Recent-IP-Passive-DNS playbook by selecting the playbook name

    ![The imported playbook is displayed.](./media/riskiq-playbook.png "Select the imported playbook")

12. Select **Edit** from the top menu of the playbook

    ![Edit is highlighted.](./media/riskiq-edit.png "Edit the imported playbook")

13. There are four steps in this playbook requiring you to configure connections. Select a Connection from one of the steps requiring configuration and configure a new connection. Select the **Invalid** icon

    ![Invalid icon error is highlighted.](./media/riskiq-edit-connection.png "Edit the connections")

14. Select **Sign in**

    ![Sign in button is highlighted.](./media/riskiq-edit-connection-signin.png "Select Sign in")

15. Enter your lab username and password.

    > **NOTE** For the connections to Azure Sentinel the user specified when establishing the connection must have sufficient permissions in the Azure Sentinel workspace to read the security alerts.

16. Expand the **For each** activity, select the the RiskIQ connection
17. Select the Invalid icon
18. For the name, type **RiskIQ**
19. Enter your RiskIQ API token and secret obtained from RiskIQ portal

    ![RiskIQ settings are displayed.](./media/riskiq-edit-connection-riskiq.png "Enter your information")

20. Select **Save** from the top menu of the playbook to save the playbook
21. Navigate to your Azure Sentinel Analytics page and select an existing analytics rule or template item you wish to add the playbook automation.
22. Select Edit for the **Custom Threats** rule you created earlier

    > **NOTE** The Recent-IP-Passive-DNS playbook works with analytics rules which map IP address entities so make sure you are working with such a rule. For simple testing of the playbook automation you can use rule logic as shown below to force an alert creation with a specific IP address.

    ```output
    AzureActivity
    | take 1
    | extend IPCustomEntity = "144.91.119.160"
    ```

23. Navigate to the Automated response tab and place a check mark in the box for the Recent-IP-Passive-DNS playbook which will enable the playbook to run each time the analytic rule generates security alerts
24. Select **Save** to finish and return to the Analytics page
25. Navigate to your Azure Sentinel Incidents page
26. Locate the incident generated from the analytic rule configured to run the Recent-IP-Passive-DNS playbook automation and select **Full details** from the information pane
27. Select the **Comments** tab to see the enrichment added by the Recent-IP-Passive-DNS playbook automation. You can also view the information in the RiskIQ portal by following the link provided at the bottom of the comment

## Reference Links

- [What is Azure Sentinel](https://docs.microsoft.com/en-us/azure/sentinel/overview)
- [Investigate incidents with Azure Sentinel](https://docs.microsoft.com/en-us/azure/sentinel/tutorial-investigate-cases)
- Azure Sentinel Notebooks
- [Enrich Azure Sentinel security incidents with the RiskIQ Intelligence Connector](https://techcommunity.microsoft.com/t5/azure-sentinel/enrich-azure-sentinel-security-incidents-with-the-riskiq/ba-p/1534412)
